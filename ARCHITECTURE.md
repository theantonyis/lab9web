# Архітектура комунікацій в реальному часі

Цей документ описує архітектуру системи комунікацій в реальному часі, яка використовується в цьому додатку для чату.

## Огляд

Додаток використовує архітектуру на основі WebSocket для двонаправленого зв'язку в реальному часі між клієнтами та сервером. Це забезпечує миттєву доставку повідомлень, функціональність чату на основі кімнат та можливості обміну файлами.

## Компоненти системи

### Бекенд

1. **WebSocket сервер**
   - Побудований з використанням бібліотеки `ws` в Node.js
   - Обробляє підключення клієнтів, маршрутизацію повідомлень та управління кімнатами
   - Підтримує стан підключених клієнтів та чат-кімнат в пам'яті

2. **Структури даних**
   - Карта `clients`: Зберігає інформацію про клієнтів (сокет -> {ім'я, кімната})
   - Карта `rooms`: Керує членством у кімнатах (кімната -> Набір сокетів)

3. **Аутентифікація**
   - Проста аутентифікація на основі токенів з використанням JSON, закодованого в base64
   - Токен містить ім'я користувача для ідентифікації

4. **Обробка повідомлень**
   - Аналізує вхідні JSON-повідомлення
   - Маршрутизує повідомлення на основі їх типу (auth, join, chat, file)
   - Транслює повідомлення відповідним учасникам кімнати

### Фронтенд

1. **WebSocket клієнт**
   - Використовує нативний WebSocket API браузера
   - Обробляє підключення, надсилання повідомлень та логіку повторного підключення

2. **Інтерфейс користувача**
   - Розділ аутентифікації для входу користувача
   - Управління кімнатами для приєднання до чат-кімнат
   - Відображення повідомлень та введення для функціональності чату
   - Можливість завантаження файлів для обміну файлами

## Потік комунікації

1. **Встановлення з'єднання**
   - Клієнт встановлює WebSocket з'єднання з сервером
   - Сервер приймає з'єднання та очікує аутентифікації

2. **Аутентифікація**
   - Клієнт надсилає повідомлення 'auth' з токеном, закодованим в base64
   - Сервер перевіряє токен та пов'язує клієнта з ім'ям користувача

3. **Управління кімнатами**
   - Клієнт надсилає повідомлення 'join' для входу в певну кімнату
   - Сервер додає клієнта до кімнати та повідомляє клієнта

4. **Обмін повідомленнями**
   - Клієнт надсилає повідомлення 'chat' на сервер
   - Сервер транслює повідомлення всім клієнтам у тій самій кімнаті

5. **Обмін файлами**
   - Клієнт кодує файл як URL-адресу даних base64 та надсилає на сервер
   - Сервер транслює дані файлу всім клієнтам у тій самій кімнаті
   - Клієнти, що отримують, можуть завантажити файл

6. **Завершення з'єднання**
   - Коли клієнт відключається, сервер видаляє його з кімнат
   - Клієнт автоматично намагається повторно підключитися, якщо відключення було несподіваним

## Міркування щодо масштабованості

Поточна реалізація використовує зберігання в пам'яті для інформації про клієнтів та кімнати, що добре працює для малих та середніх розгортань. Для додатків більшого масштабу розгляньте:

1. **Розподілене зберігання**
   - Можна реалізувати розподілене рішення для зберігання для управління кімнатами та збереження повідомлень
   - Варіанти включають Redis, MongoDB або інші системи баз даних

2. **Балансування навантаження**
   - Кілька WebSocket серверів можуть бути розгорнуті за балансувальником навантаження
   - Потребуватиме спільного управління станом (наприклад, Redis) для узгодженості кімнат

3. **Черга повідомлень**
   - Для сценаріїв з високим обсягом можна ввести чергу повідомлень
   - Відокремить обробку повідомлень від WebSocket сервера

## Міркування щодо безпеки

1. **Аутентифікація**
   - Поточна реалізація використовує просте кодування base64
   - Виробничі системи повинні використовувати JWT або подібне для безпечної аутентифікації

2. **Перевірка введення**
   - Всі вхідні повідомлення повинні бути перевірені на формат та вміст
   - Для обміну файлами повинні бути реалізовані обмеження розміру файлу

3. **Обмеження швидкості**
   - Розгляньте можливість впровадження обмеження швидкості для запобігання зловживанням
   - Може базуватися на IP-адресі підключення, ID користувача або частоті повідомлень
